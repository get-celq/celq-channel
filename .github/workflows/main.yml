name: Test Guix Channel
on:
  workflow_dispatch:
jobs:
  test-guix-build:
    runs-on: ubuntu-latest
    container:
      image: metacall/guix:latest
      options: --privileged
    
    steps:
      - name: Checkout celq-channel
        uses: actions/checkout@v4
      
      - name: Checkout celq repository (for smoke tests)
        uses: actions/checkout@v4
        with:
          repository: IvanIsCoding/celq
          path: celq-repo
      
      - name: Copy smoke tests
        run: |
          cp celq-repo/.github/scripts/smoke-test.sh .
      
      - name: Build celq package
        run: |
          /entry-point.sh guix build -L . celq
      
      - name: Run smoke tests
        run: |
          CELQ_PATH=$(/entry-point.sh guix build -L . celq)/bin/celq
          bash smoke-test.sh "$CELQ_PATH"